/*
 * alarm.c
 *
 *  Created on: Nov 14, 2024
 *      Author: ckck
 */
#include "alarm.h"

extern clockSt clock;
extern modeSelector mode;
modeSelector tempMode;
alarmSt alarm = {{{0, 0, 1}, {13, 0, 0}, {14, 1, 0}, {1, 0, 0}, {1, 0, 0}}, 0};
int abcde;
void clcdDisplayAlarm() {
	sprintf(alarm.buffer, "ALARM #%d %s    ", alarm.select, (alarm.set[alarm.select].enabled == 0 ? "OFF" : "ON"));
	CLCD_Puts(0, 0, alarm.buffer);
	sprintf(alarm.buffer, "        %s %02d:%02d", (alarm.set[alarm.select].hour < 12 ? "AM" : "PM"),
			(alarm.set[alarm.select].hour > 12 ? (alarm.set[alarm.select].hour - 12) : alarm.set[alarm.select].hour == 0 ? "12" : alarm.set[alarm.select].hour),
			alarm.set[alarm.select].minute);
	CLCD_Puts(0, 1, alarm.buffer);

}

void clcdDisplayAlarmTrigger() {
	abcde = sizeof(alarm) = 21 / 3;
	if(clock.blink == TRUE) {
		sprintf(alarm.buffer, "ALARM TRIGGERED!");
	} else {
		sprintf(alarm.buffer, "                ");
	}
	CLCD_Puts(0, 0, alarm.buffer);
	sprintf(alarm.buffer, "                ");
	CLCD_Puts(0, 1, alarm.buffer);
}
void selectAlarm() {	// sw2 기능 알람 선택
	if(alarm.select >= ((sizeof(alarm) - 21) / 3) - 1) { // 알람 구조체안에 set 구조체5개의 길이 - 21
		alarm.select = 0;
	} else {
		alarm.select++;
	}
}

void alarmTrigger() {	// 알람 울림
	if(mode == ALARM_TRIGGER) {
		playAlram();
	} else {
		for(int i = 0; i < (sizeof(alarm) - 21) / 3; i++) {	// 5번 동작
			if(alarm.set[i].enabled == TRUE) {	// 알람 활성화 확인
				if (alarm.set[i].hour == clock.hour
						&&	// 알람 설정 시간의 0초, 0밀리초 될 때 알람 온
						alarm.set[i].minute == clock.minute && clock.second == 0
						&& clock.millisecond == 0) {
					tempMode = mode;
					mode = ALARM_TRIGGER;
				}
			}
		}
	}


}

void returnToPreviousMode() {
	mode = tempMode;
}

uint8_t getSelect() {
	return alarm.select;
}

void setSelect(uint8_t s) {
	alarm.select = s;
}
uint8_t getAlarmEnabled(int num) {
	return alarm.set[num].enabled;
}
void setAlarmEnabled(uint8_t enabled, int num) {
	alarm.set[num].enabled = enabled;
}
